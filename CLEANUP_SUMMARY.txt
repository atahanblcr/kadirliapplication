================================================================================
                    BACKEND CLEANUP ANALYSIS - SUMMARY
================================================================================

PROJECT: KadirliApp
DATE: 26 February 2026
SCOPE: Remove BUSINESS role, public campaign/death creation, file uploads

================================================================================
                              OVERVIEW
================================================================================

ITEMS TO REMOVE:
1. BUSINESS role (UserRole.BUSINESS enum value)
2. Public campaign creation endpoint (POST /campaigns with @Roles(BUSINESS))
3. Public death notice creation endpoint (POST /deaths for any user)
4. Business entity & BusinessCategory (database entities + admin CRUD)
5. File upload endpoints (POST /files/upload, DELETE /files/:id)

PRESERVED FUNCTIONALITY:
✓ Campaign browsing (GET /campaigns, GET /campaigns/:id)
✓ Campaign admin management (admin panel CRUD)
✓ Death notice browsing (GET /deaths)
✓ File storage (FileEntity) for images in other modules
✓ All other 15 modules

================================================================================
                         DETAILED BREAKDOWN
================================================================================

1. ENUM & ROLE CHANGES
   File: /backend/src/common/enums/user-role.enum.ts
   Action: Remove line "BUSINESS = 'business',"
   Remaining roles: USER, TAXI_DRIVER, MODERATOR, ADMIN, SUPER_ADMIN

2. CAMPAIGNS MODULE (PUBLIC)
   Files to Modify:
   - campaigns.controller.ts: Remove POST /campaigns endpoint
   - campaigns.service.ts: Remove create(userId, dto) method
   - campaigns.module.ts: Remove Business from TypeOrmModule
   
   Keep: GET endpoints (findAll, findOne, viewCode)

3. CAMPAIGNS MODULE (ADMIN)
   File: /backend/src/admin/campaign-admin.controller.ts
   Remove: Business CRUD operations (lines 31-53)
   Keep: Campaign CRUD operations (lines 55-90)

4. BUSINESS ENTITIES (DELETE ENTIRE FILES)
   - /backend/src/database/entities/business.entity.ts (80 lines)
   - /backend/src/database/entities/business-category.entity.ts (43 lines)

5. BUSINESS ADMIN OPERATIONS
   File: /backend/src/admin/admin.service.ts
   Remove Methods:
   - getAdminBusinesses()
   - getBusinessCategories()
   - createBusinessCategory(dto)
   - createAdminBusiness(dto)
   
   Remove Repositories: businessRepository, businessCategoryRepository

6. DTOs (DELETE ENTIRE FILES)
   - /backend/src/campaigns/dto/create-campaign.dto.ts
   - /backend/src/admin/dto/create-admin-business.dto.ts
   - /backend/src/admin/dto/create-business-category.dto.ts

7. DEATHS MODULE (PUBLIC)
   File: /backend/src/deaths/deaths.controller.ts
   Remove: @Post() create() method (lines 116-123)
   Keep: GET endpoints, Admin operations

8. FILE UPLOADS (OPTIONAL - IF NOT USED INTERNALLY)
   Files to Delete/Modify:
   - /backend/src/files/files.controller.ts: Remove POST/DELETE methods
   - /backend/src/files/files.service.ts: Remove uploadFile, deleteFile methods
   - /backend/src/files/dto/upload-file.dto.ts: Delete entire file
   
   Keep: FileEntity (needed for image storage)

9. ADMIN MODULE UPDATES
   File: /backend/src/admin/admin.module.ts
   Remove: Business, BusinessCategory imports from:
   - import statements
   - TypeOrmModule.forFeature([...])

10. DATABASE MIGRATION
    Create NEW migration to:
    - Drop tables (in order): campaign_code_views, campaign_images, campaigns, businesses, business_categories
    - Update enum: Remove 'business' value from users_role_enum
    - Update default: users.notification_preferences (remove 'campaigns' key)

11. DOCUMENTATION
    Update: /docs/04_API_ENDPOINTS_MASTER.md (remove campaign creation, file upload)
    Update: /docs/01_DATABASE_SCHEMA_FULL.sql (remove business/campaign tables)
    Update: /docs/02_ERD_DIAGRAM.md (remove business/campaign entities)
    Update: CLAUDE.md (change 17 modules → 16 modules)

12. TESTS
    Update: admin.service.spec.ts (remove business role tests)
    Update: campaigns.controller.spec.ts (remove POST tests)
    Update: campaigns.service.spec.ts (remove create tests)
    Update: files.controller.spec.ts (remove upload tests)
    Update: files.service.spec.ts (remove file service tests)

================================================================================
                            FILES INVENTORY
================================================================================

DELETION CANDIDATES (8 files total):

1. /backend/src/campaigns/dto/create-campaign.dto.ts (72 lines)
   Purpose: DTO for business users creating campaigns
   
2. /backend/src/database/entities/business.entity.ts (80 lines)
   Purpose: Business account record (tied to User with OneToOne)
   
3. /backend/src/database/entities/business-category.entity.ts (43 lines)
   Purpose: Business categories with hierarchical support
   
4. /backend/src/admin/dto/create-admin-business.dto.ts (21 lines)
   Purpose: Admin-side business creation
   
5. /backend/src/admin/dto/create-business-category.dto.ts (8 lines)
   Purpose: Admin-side business category creation
   
6. /backend/src/files/files.controller.ts (79 lines)
   Purpose: Public file upload endpoints
   
7. /backend/src/files/files.service.ts (85 lines)
   Purpose: File upload/delete service
   
8. /backend/src/files/dto/upload-file.dto.ts (variable lines)
   Purpose: File upload request DTO

MODIFICATION TARGETS (21 files total):

Core Changes:
- user-role.enum.ts: Remove BUSINESS value
- campaigns.controller.ts: Remove POST endpoint
- campaigns.service.ts: Remove create() method
- campaigns.module.ts: Remove Business import
- admin.module.ts: Remove Business/BusinessCategory imports
- admin.service.ts: Remove business methods + repositories
- admin/campaign-admin.controller.ts: Remove business operations
- deaths.controller.ts: Remove POST endpoint
- app.module.ts: Optional if removing campaigns entirely

Tests:
- admin.service.spec.ts: Remove business role tests
- campaigns.controller.spec.ts: Remove POST tests
- campaigns.service.spec.ts: Remove create tests
- files.controller.spec.ts: Remove upload tests
- files.service.spec.ts: Remove file service tests
- admin/campaign-admin.controller.spec.ts: Update tests

Database:
- 1771619909777-InitialSchema.ts: Remove business/campaign table definitions
- (Create new migration for drop operations)

Documentation:
- 04_API_ENDPOINTS_MASTER.md: Remove campaign creation section
- 01_DATABASE_SCHEMA_FULL.sql: Remove business/campaign tables
- 02_ERD_DIAGRAM.md: Remove business/campaign entities
- CLAUDE.md: Update module count (17 → 16)

PRESERVATION (Keep Unchanged):
- campaign.entity.ts: Keep Campaign entity (needed for admin operations)
- file.entity.ts: Keep FileEntity (needed for image storage)
- All public campaign GET endpoints
- All admin campaign CRUD operations
- All death notice GET endpoints
- All other modules (15 unaffected modules)

================================================================================
                        DEPENDENCY ANALYSIS
================================================================================

DIRECT DEPENDENCIES BEING REMOVED:
1. CampaignsService.create() → Requires: Business repository
2. CampaignsController.create() → Requires: CreateCampaignDto, CampaignsService.create()
3. DeathsController.create() → Requires: CreateDeathNoticeDto, DeathsService.create()
4. FilesController.uploadFile() → Requires: FileInterceptor, FilesService.uploadFile()
5. AdminService.getAdminBusinesses() → Requires: Business repository
6. CampaignAdminController business operations → Requires: AdminService business methods

PRESERVED DEPENDENCIES:
- Campaign entity (still needed for admin operations)
- FileEntity (still needed for storing images)
- All 15 other modules (unaffected)

DATABASE CASCADE EFFECTS:
- Deleting business records → Cascades to campaigns (business_id FK)
- Deleting campaigns → Cascades to campaign_images, campaign_code_views
- Deleting users with BUSINESS role → Cascades to their business record

================================================================================
                        IMPLEMENTATION SEQUENCE
================================================================================

PHASE 1: Code Cleanup (2 hours)
  Step 1: Delete 8 DTO/Entity files
  Step 2: Remove POST endpoints from controllers (3 files)
  Step 3: Remove service methods (3 files)
  Step 4: Remove module imports (2 files)
  Step 5: Remove enum value (1 file)
  Step 6: Update test files (5 files)
  Result: Code compiles, but database schema still has old tables

PHASE 2: Database Migration (1 hour)
  Step 7: Create migration to drop tables
  Step 8: Update enum type definition
  Step 9: Update notification_preferences defaults
  Step 10: Run migration
  Result: Database schema cleaned up

PHASE 3: Documentation (30 minutes)
  Step 11: Update API documentation
  Step 12: Update database schema documentation
  Step 13: Update ERD diagram
  Step 14: Update CLAUDE.md

PHASE 4: Testing (1 hour)
  Step 15: Run full test suite
  Step 16: Fix any failing tests
  Step 17: Manual API testing
  Step 18: Verify database integrity

TOTAL ESTIMATED TIME: 4.5 hours

================================================================================
                        CRITICAL NOTES
================================================================================

⚠️ DATA LOSS: All business records, campaigns, and their related data will be
   deleted. Consider exporting this data first if needed.

⚠️ ENUM UPDATE: PostgreSQL enum type modifications are tricky. Must:
   1. Create new type with correct values
   2. Cast column to TEXT
   3. Change column type to new enum type
   4. Drop old type
   5. Rename new type to original name

⚠️ MIGRATION: Create NEW migration file instead of modifying the initial schema.
   This preserves audit trail and allows rollback if needed.

⚠️ CASCADING DELETES: Foreign key constraints with CASCADE DELETE will
   automatically delete:
   - All campaigns when their business is deleted
   - All campaign_images when their campaign is deleted
   - All campaign_code_views when their campaign is deleted

⚠️ TEST COVERAGE: Removing ~50+ test cases will decrease coverage.
   Plan to add tests for other modules to compensate.

✓ SAFE OPERATIONS:
   - Keeping Campaign entity doesn't break anything
   - Keeping FileEntity doesn't break anything
   - Public campaign browsing remains fully functional
   - Admin campaign management remains fully functional

================================================================================
                        VERIFICATION COMMANDS
================================================================================

POST-CLEANUP SQL CHECKS:

-- Verify no BUSINESS role users
SELECT COUNT(*) FROM users WHERE role = 'business';
-- Expected: 0

-- Verify campaigns table still exists (if keeping)
SELECT COUNT(*) FROM campaigns;
-- Expected: May vary

-- Verify enum doesn't have 'business'
SELECT enum_range(null::"users_role_enum");
-- Expected: Should NOT contain 'business'

-- Verify no orphaned campaigns (if keeping campaigns)
SELECT COUNT(*) FROM campaigns 
WHERE business_id NOT IN (SELECT id FROM businesses);
-- Expected: 0 (or cleanup needed)

POST-CLEANUP API TESTS:

-- These endpoints should NOT exist (404 or 403):
curl -X POST http://localhost:3000/v1/campaigns  
curl -X POST http://localhost:3000/v1/deaths
curl -X POST http://localhost:3000/v1/files/upload
curl -X DELETE http://localhost:3000/v1/files/{id}

-- These endpoints should still work (200):
curl http://localhost:3000/v1/campaigns
curl http://localhost:3000/v1/campaigns/{id}
curl http://localhost:3000/v1/admin/campaigns  (admin only)
curl http://localhost:3000/v1/deaths/cemeteries

================================================================================
                        GENERATED DOCUMENTATION
================================================================================

Two detailed analysis documents have been created:

1. CLEANUP_ANALYSIS_BUSINESS_CAMPAIGNS_FILES.md (Comprehensive)
   - 700+ lines
   - Full code references with line numbers
   - Detailed dependency analysis
   - SQL migration specifications
   - Implementation order and sequencing

2. QUICK_REFERENCE_CLEANUP.md (Quick Reference)
   - Code snippets for each deletion
   - Checklist format
   - Fast lookup for what to keep/delete
   - Verification checklist

Use CLEANUP_ANALYSIS_BUSINESS_CAMPAIGNS_FILES.md for detailed implementation.
Use QUICK_REFERENCE_CLEANUP.md for quick lookups while coding.

================================================================================
                            SUMMARY
================================================================================

SCOPE: Removing 1 role, 3 public endpoints, 2 entities, 8 files, 21 modifications
IMPACT: No impact on remaining 15 modules, preserves campaign browsing
TIME: ~4.5 hours implementation + testing
RISK: Data loss (campaigns/businesses), Medium complexity (enum + cascade delete)
RESULT: Cleaner codebase, fewer module dependencies, simpler role system

Ready for implementation.

================================================================================
